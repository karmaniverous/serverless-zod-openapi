<!DOCTYPE html><html class="default" lang="en" data-base="./"><head><meta charset="utf-8"/><link rel="canonical" href="https://docs.karmanivero.us/smoz/"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>smoz</title><meta name="description" content="Documentation for smoz"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script defer src="assets/main.js"></script><script async src="assets/icons.js" id="tsd-icons-script"></script><script async src="assets/search.js" id="tsd-search-script"></script><script async src="assets/navigation.js" id="tsd-nav-script"></script><script async src="assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => window.app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><a href="index.html" class="title">smoz</a><div id="tsd-toolbar-links"><a href="https://github.com/karmaniverous/smoz">GitHub</a></div><button id="tsd-search-trigger" class="tsd-widget" aria-label="Search"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-search"></use></svg></button><dialog id="tsd-search" aria-label="Search"><input role="combobox" id="tsd-search-input" aria-controls="tsd-search-results" aria-autocomplete="list" aria-expanded="true" autocapitalize="off" autocomplete="off" placeholder="Search the docs" maxLength="100"/><ul role="listbox" id="tsd-search-results"></ul><div id="tsd-search-status" aria-live="polite" aria-atomic="true"><div>Preparing search index...</div></div></dialog><a href="#" class="tsd-widget menu" id="tsd-toolbar-menu-trigger" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-menu"></use></svg></a></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><h1>smoz</h1></div><div class="tsd-panel tsd-typography"><div align="center">
<h1 id="smoz" class="tsd-anchor-link">SMOZ<a href="#smoz" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h1><p><a href="https://www.serverless.com/" target="_blank" class="external">Serverless</a> · <a href="https://middy.js.org/" target="_blank" class="external">Middy</a> · <a href="https://spec.openapis.org/oas/latest.html" target="_blank" class="external">OpenAPI 3.1</a> · <a href="https://zod.dev/" target="_blank" class="external">Zod</a></p>
<p><a href="https://www.npmjs.com/package/@karmaniverous/smoz" target="_blank" class="external"><img src="https://img.shields.io/npm/v/@karmaniverous/smoz.svg" alt="npm version"></a>
<img src="https://img.shields.io/node/v/@karmaniverous/smoz" alt="Node Current">
<a href="https://github.com/karmaniverous/smoz/tree/main/LICENSE.md" target="_blank" class="external"><img src="https://img.shields.io/badge/license-BSD--3--Clause-blue.svg" alt="license"></a></p>
</div>
<p>SMOZ is a tiny, pragmatic toolkit that helps you:</p>
<ul>
<li>Author AWS Lambda handlers with <a href="https://middy.js.org/" target="_blank" class="external">Middy</a> middleware and first‑class Zod validation</li>
<li>Define your application once and generate:
<ul>
<li>Serverless functions (handler strings, HTTP events, env mapping)</li>
<li>OpenAPI 3.1 paths (hand‑crafted, no magic)</li>
</ul>
</li>
<li>Keep prod code small and testable (no framework lock‑in)</li>
</ul>
<p>It’s batteries‑included for an everyday DX: schema‑first types, env hygiene, HTTP shaping, error mapping, CORS, JSON negotiation, HEAD short‑circuiting, and a clean way to add non‑HTTP functions (SQS/Steps/etc) without touching the HTTP stack.</p>
<p>Why this stack?</p>
<ul>
<li>Serverless makes deployment boring</li>
<li>Middy is the right level of middleware</li>
<li>OpenAPI is your contract (hand‑crafted here—no leaky auto‑gen)</li>
<li>Zod is a fast, composable runtime validator that doubles as types</li>
</ul>
<h2 id="highlights" class="tsd-anchor-link">Highlights<a href="#highlights" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li>Schema‑first App class:
<ul>
<li>define global/stage params and env keys</li>
<li>extend base event‑type map (rest, http, sqs) with your own (e.g., step)</li>
<li>register functions once, then aggregate Serverless + OpenAPI</li>
</ul>
</li>
<li>HTTP runtime wrapper:
<ul>
<li>header/event normalization, JSON body parsing, content negotiation</li>
<li>Zod validation (event and response)</li>
<li>error exposure + validation→400 mapping</li>
<li>CORS and response serializer with JSON (+json vendor types)</li>
<li>HEAD short‑circuit to 200 {}</li>
</ul>
</li>
<li>Non‑HTTP stays lean:
<ul>
<li>wrapper bypasses Middy entirely for internal events</li>
<li>same options surface, no hidden toggles</li>
</ul>
</li>
</ul>
<h2 id="install" class="tsd-anchor-link">Install<a href="#install" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><pre><code class="bash"><span class="hl-0">npm</span><span class="hl-1"> </span><span class="hl-2">i</span><span class="hl-1"> </span><span class="hl-2">smoz</span><span class="hl-1"> </span><span class="hl-2">zod</span><span class="hl-1"> </span><span class="hl-2">zod-openapi</span><span class="hl-1"> </span><span class="hl-2">@middy/core</span><span class="hl-1"> </span><span class="hl-3">\</span><br/><span class="hl-1">  </span><span class="hl-2">@middy/http-header-normalizer</span><span class="hl-1"> </span><span class="hl-3">\</span><br/><span class="hl-1">  </span><span class="hl-2">@middy/http-event-normalizer</span><span class="hl-1"> </span><span class="hl-3">\</span><br/><span class="hl-1">  </span><span class="hl-2">@middy/http-json-body-parser</span><span class="hl-1"> </span><span class="hl-3">\</span><br/><span class="hl-1">  </span><span class="hl-2">@middy/http-content-negotiation</span><span class="hl-1"> </span><span class="hl-3">\</span><br/><span class="hl-1">  </span><span class="hl-2">@middy/http-error-handler</span><span class="hl-1"> </span><span class="hl-3">\</span><br/><span class="hl-1">  </span><span class="hl-2">@middy/http-cors</span><span class="hl-1"> </span><span class="hl-3">\</span><br/><span class="hl-1">  </span><span class="hl-2">@middy/http-response-serializer</span>
</code><button type="button">Copy</button></pre>

<p>Dev tooling (recommended):</p>
<pre><code class="bash"><span class="hl-0">npm</span><span class="hl-1"> </span><span class="hl-2">i</span><span class="hl-1"> </span><span class="hl-4">-D</span><span class="hl-1"> </span><span class="hl-2">typescript</span><span class="hl-1"> </span><span class="hl-2">typescript-eslint</span><span class="hl-1"> </span><span class="hl-2">eslint</span><span class="hl-1"> </span><span class="hl-2">prettier</span><span class="hl-1"> </span><span class="hl-2">typedoc</span>
</code><button type="button">Copy</button></pre>

<h2 id="quick-start" class="tsd-anchor-link">Quick start<a href="#quick-start" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><ol>
<li>Create your application config (schema‑first)</li>
</ol>
<p>app/config/app.config.ts</p>
<pre><code class="ts"><span class="hl-5">import</span><span class="hl-1"> { </span><span class="hl-6">dirname</span><span class="hl-1"> } </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-2">&#39;node:path&#39;</span><span class="hl-1">;</span><br/><span class="hl-5">import</span><span class="hl-1"> { </span><span class="hl-6">fileURLToPath</span><span class="hl-1"> } </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-2">&#39;node:url&#39;</span><span class="hl-1">;</span><br/><span class="hl-5">import</span><span class="hl-1"> { </span><span class="hl-6">z</span><span class="hl-1"> } </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-2">&#39;zod&#39;</span><span class="hl-1">;</span><br/><span class="hl-5">import</span><span class="hl-1"> { </span><span class="hl-6">App</span><span class="hl-1">, </span><span class="hl-6">baseEventTypeMapSchema</span><span class="hl-1"> } </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-2">&#39;smoz&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">APP_ROOT_ABS</span><span class="hl-1"> = </span><span class="hl-0">dirname</span><span class="hl-1">(</span><span class="hl-0">dirname</span><span class="hl-1">(</span><span class="hl-0">fileURLToPath</span><span class="hl-1">(</span><span class="hl-5">import</span><span class="hl-1">.</span><span class="hl-6">meta</span><span class="hl-1">.</span><span class="hl-6">url</span><span class="hl-1">))).</span><span class="hl-0">replace</span><span class="hl-1">(</span><span class="hl-8">/</span><span class="hl-3">\\</span><span class="hl-8">/</span><span class="hl-4">g</span><span class="hl-1">, </span><span class="hl-2">&#39;/&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-5">export</span><span class="hl-1"> </span><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">app</span><span class="hl-1"> = </span><span class="hl-6">App</span><span class="hl-1">.</span><span class="hl-0">create</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-6">appRootAbs:</span><span class="hl-1"> </span><span class="hl-7">APP_ROOT_ABS</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">globalParamsSchema:</span><span class="hl-1"> </span><span class="hl-6">z</span><span class="hl-1">.</span><span class="hl-0">object</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-6">REGION:</span><span class="hl-1"> </span><span class="hl-6">z</span><span class="hl-1">.</span><span class="hl-0">string</span><span class="hl-1">(),</span><br/><span class="hl-1">    </span><span class="hl-6">SERVICE_NAME:</span><span class="hl-1"> </span><span class="hl-6">z</span><span class="hl-1">.</span><span class="hl-0">string</span><span class="hl-1">(),</span><br/><span class="hl-1">  }),</span><br/><span class="hl-1">  </span><span class="hl-6">stageParamsSchema:</span><span class="hl-1"> </span><span class="hl-6">z</span><span class="hl-1">.</span><span class="hl-0">object</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-6">STAGE:</span><span class="hl-1"> </span><span class="hl-6">z</span><span class="hl-1">.</span><span class="hl-0">string</span><span class="hl-1">(),</span><br/><span class="hl-1">  }),</span><br/><span class="hl-1">  </span><span class="hl-6">eventTypeMapSchema:</span><span class="hl-1"> </span><span class="hl-6">baseEventTypeMapSchema</span><span class="hl-1">, </span><span class="hl-9">// extend with custom tokens if needed</span><br/><span class="hl-1">  </span><span class="hl-6">serverless:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-6">httpContextEventMap:</span><span class="hl-1"> { </span><span class="hl-6">my:</span><span class="hl-1"> {}, </span><span class="hl-6">private:</span><span class="hl-1"> { </span><span class="hl-6">private:</span><span class="hl-1"> </span><span class="hl-4">true</span><span class="hl-1"> }, </span><span class="hl-6">public:</span><span class="hl-1"> {} },</span><br/><span class="hl-1">    </span><span class="hl-6">defaultHandlerFileName:</span><span class="hl-1"> </span><span class="hl-2">&#39;handler&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-6">defaultHandlerFileExport:</span><span class="hl-1"> </span><span class="hl-2">&#39;handler&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-6">global:</span><span class="hl-1"> { </span><span class="hl-6">params:</span><span class="hl-1"> { </span><span class="hl-6">REGION:</span><span class="hl-1"> </span><span class="hl-2">&#39;us-east-1&#39;</span><span class="hl-1">, </span><span class="hl-6">SERVICE_NAME:</span><span class="hl-1"> </span><span class="hl-2">&#39;my-svc&#39;</span><span class="hl-1"> }, </span><span class="hl-6">envKeys:</span><span class="hl-1"> [</span><span class="hl-2">&#39;REGION&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;SERVICE_NAME&#39;</span><span class="hl-1">] },</span><br/><span class="hl-1">  </span><span class="hl-6">stage:</span><span class="hl-1"> { </span><span class="hl-6">params:</span><span class="hl-1"> { </span><span class="hl-6">dev:</span><span class="hl-1"> { </span><span class="hl-6">STAGE:</span><span class="hl-1"> </span><span class="hl-2">&#39;dev&#39;</span><span class="hl-1"> } }, </span><span class="hl-6">envKeys:</span><span class="hl-1"> [</span><span class="hl-2">&#39;STAGE&#39;</span><span class="hl-1">] },</span><br/><span class="hl-1">});</span><br/><span class="hl-5">export</span><span class="hl-1"> </span><span class="hl-4">const</span><span class="hl-1"> { </span><span class="hl-7">stages</span><span class="hl-1">, </span><span class="hl-7">environment</span><span class="hl-1">, </span><span class="hl-7">buildFnEnv</span><span class="hl-1"> } = </span><span class="hl-6">app</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

<ol start="2">
<li>Define an HTTP endpoint</li>
</ol>
<p>app/endpoints/hello/get/lambda.ts</p>
<pre><code class="ts"><span class="hl-5">import</span><span class="hl-1"> { </span><span class="hl-6">z</span><span class="hl-1"> } </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-2">&#39;zod&#39;</span><span class="hl-1">;</span><br/><span class="hl-5">import</span><span class="hl-1"> { </span><span class="hl-6">app</span><span class="hl-1"> } </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@/app/config/app.config&#39;</span><span class="hl-1">;</span><br/><span class="hl-5">import</span><span class="hl-1"> { </span><span class="hl-6">ENDPOINTS_ROOT</span><span class="hl-1"> } </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@/app/endpoints/_root&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-5">export</span><span class="hl-1"> </span><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">responseSchema</span><span class="hl-1"> = </span><span class="hl-6">z</span><span class="hl-1">.</span><span class="hl-0">object</span><span class="hl-1">({ </span><span class="hl-6">ok:</span><span class="hl-1"> </span><span class="hl-6">z</span><span class="hl-1">.</span><span class="hl-0">boolean</span><span class="hl-1">() });</span><br/><br/><span class="hl-5">export</span><span class="hl-1"> </span><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">fn</span><span class="hl-1"> = </span><span class="hl-6">app</span><span class="hl-1">.</span><span class="hl-0">defineFunction</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-6">functionName:</span><span class="hl-1"> </span><span class="hl-2">&#39;hello_get&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">eventType:</span><span class="hl-1"> </span><span class="hl-2">&#39;rest&#39;</span><span class="hl-1">, </span><span class="hl-9">// &#39;http&#39; works too; both are “HTTP tokens” at runtime</span><br/><span class="hl-1">  </span><span class="hl-6">httpContexts:</span><span class="hl-1"> [</span><span class="hl-2">&#39;public&#39;</span><span class="hl-1">],</span><br/><span class="hl-1">  </span><span class="hl-6">method:</span><span class="hl-1"> </span><span class="hl-2">&#39;get&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">basePath:</span><span class="hl-1"> </span><span class="hl-2">&#39;hello&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">contentType:</span><span class="hl-1"> </span><span class="hl-2">&#39;application/json&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-9">// eventSchema: z.object({ ... }) // optional request validation</span><br/><span class="hl-1">  </span><span class="hl-6">responseSchema</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">callerModuleUrl:</span><span class="hl-1"> </span><span class="hl-5">import</span><span class="hl-1">.</span><span class="hl-6">meta</span><span class="hl-1">.</span><span class="hl-6">url</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">endpointsRootAbs:</span><span class="hl-1"> </span><span class="hl-7">ENDPOINTS_ROOT</span><span class="hl-1">,</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p>app/endpoints/hello/get/handler.ts</p>
<pre><code class="ts"><span class="hl-5">import</span><span class="hl-1"> { </span><span class="hl-6">fn</span><span class="hl-1">, </span><span class="hl-6">responseSchema</span><span class="hl-1"> } </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-2">&#39;./lambda&#39;</span><span class="hl-1">;</span><br/><span class="hl-4">type</span><span class="hl-1"> </span><span class="hl-10">Response</span><span class="hl-1"> = </span><span class="hl-4">import</span><span class="hl-1">(</span><span class="hl-2">&#39;zod&#39;</span><span class="hl-1">).</span><span class="hl-10">infer</span><span class="hl-1">&lt;</span><span class="hl-4">typeof</span><span class="hl-1"> </span><span class="hl-6">responseSchema</span><span class="hl-1">&gt;;</span><br/><span class="hl-5">export</span><span class="hl-1"> </span><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">handler</span><span class="hl-1"> = </span><span class="hl-6">fn</span><span class="hl-1">.</span><span class="hl-0">handler</span><span class="hl-1">(</span><span class="hl-4">async</span><span class="hl-1"> () </span><span class="hl-4">=&gt;</span><span class="hl-1"> ({ </span><span class="hl-6">ok:</span><span class="hl-1"> </span><span class="hl-4">true</span><span class="hl-1"> }) </span><span class="hl-5">satisfies</span><span class="hl-1"> </span><span class="hl-10">Response</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<ol start="3">
<li>Generate OpenAPI (hand‑crafted entries)</li>
</ol>
<pre><code class="ts"><span class="hl-9">// app/config/openapi.ts</span><br/><span class="hl-5">import</span><span class="hl-1"> </span><span class="hl-2">&#39;@/app/endpoints/hello/get/lambda&#39;</span><span class="hl-1">;</span><br/><span class="hl-5">import</span><span class="hl-1"> </span><span class="hl-2">&#39;@/app/endpoints/hello/get/openapi&#39;</span><span class="hl-1">; </span><span class="hl-9">// attach path item info</span><br/><span class="hl-5">import</span><span class="hl-1"> </span><span class="hl-6">fs</span><span class="hl-1"> </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-2">&#39;fs-extra&#39;</span><span class="hl-1">;</span><br/><span class="hl-5">import</span><span class="hl-1"> </span><span class="hl-6">path</span><span class="hl-1"> </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-2">&#39;path&#39;</span><span class="hl-1">;</span><br/><span class="hl-5">import</span><span class="hl-1"> { </span><span class="hl-6">packageDirectorySync</span><span class="hl-1"> } </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-2">&#39;pkg-dir&#39;</span><span class="hl-1">;</span><br/><span class="hl-5">import</span><span class="hl-1"> { </span><span class="hl-6">createDocument</span><span class="hl-1"> } </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-2">&#39;zod-openapi&#39;</span><span class="hl-1">;</span><br/><span class="hl-5">import</span><span class="hl-1"> { </span><span class="hl-6">app</span><span class="hl-1"> } </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@/app/config/app.config&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">paths</span><span class="hl-1"> = </span><span class="hl-6">app</span><span class="hl-1">.</span><span class="hl-0">buildAllOpenApiPaths</span><span class="hl-1">();</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">doc</span><span class="hl-1"> = </span><span class="hl-0">createDocument</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-6">openapi:</span><span class="hl-1"> </span><span class="hl-2">&#39;3.1.0&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">servers:</span><span class="hl-1"> [{ </span><span class="hl-6">description:</span><span class="hl-1"> </span><span class="hl-2">&#39;Dev&#39;</span><span class="hl-1">, </span><span class="hl-6">url:</span><span class="hl-1"> </span><span class="hl-2">&#39;http://localhost&#39;</span><span class="hl-1"> }],</span><br/><span class="hl-1">  </span><span class="hl-6">info:</span><span class="hl-1"> { </span><span class="hl-6">title:</span><span class="hl-1"> </span><span class="hl-2">&#39;smoz&#39;</span><span class="hl-1">, </span><span class="hl-6">version:</span><span class="hl-1"> </span><span class="hl-6">process</span><span class="hl-1">.</span><span class="hl-6">env</span><span class="hl-1">.</span><span class="hl-6">npm_package_version</span><span class="hl-1"> ?? </span><span class="hl-2">&#39;&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">  </span><span class="hl-6">paths</span><span class="hl-1">,</span><br/><span class="hl-1">});</span><br/><span class="hl-6">fs</span><span class="hl-1">.</span><span class="hl-0">writeFileSync</span><span class="hl-1">(</span><span class="hl-6">path</span><span class="hl-1">.</span><span class="hl-0">join</span><span class="hl-1">(</span><span class="hl-0">packageDirectorySync</span><span class="hl-1">()!, </span><span class="hl-2">&#39;app/openapi.json&#39;</span><span class="hl-1">), </span><span class="hl-7">JSON</span><span class="hl-1">.</span><span class="hl-0">stringify</span><span class="hl-1">(</span><span class="hl-6">doc</span><span class="hl-1">, </span><span class="hl-4">null</span><span class="hl-1">, </span><span class="hl-11">2</span><span class="hl-1">));</span>
</code><button type="button">Copy</button></pre>

<p>Run:</p>
<pre><code class="bash"><span class="hl-0">npm</span><span class="hl-1"> </span><span class="hl-2">run</span><span class="hl-1"> </span><span class="hl-2">openapi</span>
</code><button type="button">Copy</button></pre>

<ol start="4">
<li>Package / Deploy with Serverless</li>
</ol>
<p>serverless.ts (snippet)</p>
<pre><code class="ts"><span class="hl-5">import</span><span class="hl-1"> </span><span class="hl-2">&#39;@/app/endpoints/hello/get/lambda&#39;</span><span class="hl-1">;</span><br/><span class="hl-5">import</span><span class="hl-1"> </span><span class="hl-5">type</span><span class="hl-1"> { </span><span class="hl-6">AWS</span><span class="hl-1"> } </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@serverless/typescript&#39;</span><span class="hl-1">;</span><br/><span class="hl-5">import</span><span class="hl-1"> { </span><span class="hl-6">app</span><span class="hl-1">, </span><span class="hl-6">environment</span><span class="hl-1">, </span><span class="hl-6">stages</span><span class="hl-1"> } </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@/app/config/app.config&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">config</span><span class="hl-1">: </span><span class="hl-10">AWS</span><span class="hl-1"> = {</span><br/><span class="hl-1">  </span><span class="hl-6">service:</span><span class="hl-1"> </span><span class="hl-2">&#39;${param:SERVICE_NAME}&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">frameworkVersion:</span><span class="hl-1"> </span><span class="hl-2">&#39;4&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">stages</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-6">provider:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-6">name:</span><span class="hl-1"> </span><span class="hl-2">&#39;aws&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-6">region:</span><span class="hl-1"> </span><span class="hl-2">&#39;${param:REGION}&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-6">environment</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-6">runtime:</span><span class="hl-1"> </span><span class="hl-2">&#39;nodejs22.x&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-6">functions:</span><span class="hl-1"> </span><span class="hl-6">app</span><span class="hl-1">.</span><span class="hl-0">buildAllServerlessFunctions</span><span class="hl-1">() </span><span class="hl-5">as</span><span class="hl-1"> </span><span class="hl-10">NonNullable</span><span class="hl-1">&lt;</span><span class="hl-10">AWS</span><span class="hl-1">[</span><span class="hl-2">&#39;functions&#39;</span><span class="hl-1">]&gt;,</span><br/><span class="hl-1">};</span><br/><span class="hl-5">export</span><span class="hl-1"> </span><span class="hl-5">default</span><span class="hl-1"> </span><span class="hl-6">config</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

<pre><code class="bash"><span class="hl-0">npm</span><span class="hl-1"> </span><span class="hl-2">run</span><span class="hl-1"> </span><span class="hl-2">package</span>
</code><button type="button">Copy</button></pre>

<h2 id="what-you-get-http-stack" class="tsd-anchor-link">What you get (HTTP stack)<a href="#what-you-get-http-stack" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>SMOZ’s HTTP wrapper composes a robust Middy pipeline:</p>
<ol>
<li>HEAD short‑circuit (200 {} immediately)</li>
<li>Header normalization (canonical case)</li>
<li>APIGW v1 event normalization</li>
<li>Content negotiation (JSON, vendor +json)</li>
<li>Safe JSON body parsing (no 415 surprises)</li>
<li>Zod validation (event before handler, response after handler)</li>
<li>Error exposure + validation→400 mapping</li>
<li>http‑error‑handler with your logger</li>
<li>CORS (credentials on; preserves computed origin)</li>
<li>Preferred media types defaults across phases</li>
<li>Response shaper (statusCode/headers/body) + content‑type enforcement</li>
<li>Response serializer (JSON and vendor +json)</li>
</ol>
<p>Non‑HTTP events bypass Middy entirely, so your internal handlers stay tiny and fast.</p>
<h2 id="http-middleware-customization" class="tsd-anchor-link">HTTP middleware customization<a href="#http-middleware-customization" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>SMOZ exposes a modular customization surface for the HTTP middleware stack while
keeping robust defaults. You can set app‑wide defaults and profiles, then refine
per function with simple options, phased extensions, targeted transforms, or a
full replace (phased arrays).</p>
<p>Surfaces:</p>
<ul>
<li>App level (optional; in App.create):
<ul>
<li>http.defaults: HttpStackOptions (e.g., contentType, logger)</li>
<li>http.profiles: Record&lt;string, HttpProfile&gt; (options + extend/transform)</li>
</ul>
</li>
<li>Function level (optional; in app.defineFunction):
<ul>
<li>http profile: pick one profile by name</li>
<li>http options: Partial<HttpStackOptions> (shallow overrides)</li>
<li>extend: append steps into phases (before/after/onError)</li>
<li>transform: pure function that can insert/replace/remove steps by ID</li>
<li>replace: supply phased arrays or a single middleware (see footgun note)</li>
</ul>
</li>
</ul>
<p>Merge order:</p>
<ol>
<li>defaults (app) → 2) profile (app) → 3) options (function) → 4) extend
(defaults → profile → function) → 5) transform (defaults → profile →
function) → 6) replace (function; final).</li>
</ol>
<p>Step IDs and invariants:</p>
<ul>
<li>Stable step IDs (in order around the core):
<ul>
<li>before: head, header-normalizer, event-normalizer, content-negotiation,
json-body-parser, zod-before</li>
<li>after: head-finalize, zod-after, error-expose, cors, preferred-media, shape, serializer</li>
<li>onError: error-expose, error-handler</li>
</ul>
</li>
<li>Invariants enforced:
<ul>
<li>head must be first in before</li>
<li>serializer must be last in after</li>
<li>shape must precede serializer in after</li>
<li>error-handler may appear only in onError</li>
</ul>
</li>
<li>Zod enforcement:
<ul>
<li>If eventSchema or responseSchema is provided, the final stack must include
zod-before (before) and zod-after (after). You may supply custom validators,
but they must be tagged with these IDs.</li>
</ul>
</li>
</ul>
<p>Examples:</p>
<ul>
<li>Choose a profile and override content type:<pre><code class="ts"><span class="hl-6">app</span><span class="hl-1">.</span><span class="hl-0">defineFunction</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-9">// ...</span><br/><span class="hl-1">  </span><span class="hl-6">http:</span><span class="hl-1"> { </span><span class="hl-6">profile:</span><span class="hl-1"> </span><span class="hl-2">&#39;publicJson&#39;</span><span class="hl-1">, </span><span class="hl-6">options:</span><span class="hl-1"> { </span><span class="hl-6">contentType:</span><span class="hl-1"> </span><span class="hl-2">&#39;application/vnd.my+json&#39;</span><span class="hl-1"> } },</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

</li>
<li>Insert a header after the response shaper:<pre><code class="ts"><span class="hl-5">import</span><span class="hl-1"> { </span><span class="hl-6">insertAfter</span><span class="hl-1"> } </span><span class="hl-5">from</span><span class="hl-1"> </span><span class="hl-2">&#39;smoz&#39;</span><span class="hl-1">;</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-7">mw</span><span class="hl-1"> = { </span><span class="hl-0">after</span><span class="hl-6">:</span><span class="hl-1"> (</span><span class="hl-6">req</span><span class="hl-1">: </span><span class="hl-10">any</span><span class="hl-1">) </span><span class="hl-4">=&gt;</span><span class="hl-1"> { </span><span class="hl-6">req</span><span class="hl-1">.</span><span class="hl-6">response</span><span class="hl-1">.</span><span class="hl-6">headers</span><span class="hl-1">[</span><span class="hl-2">&#39;X-My&#39;</span><span class="hl-1">] = </span><span class="hl-2">&#39;yes&#39;</span><span class="hl-1">; } };</span><br/><span class="hl-6">app</span><span class="hl-1">.</span><span class="hl-0">defineFunction</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-9">// ...</span><br/><span class="hl-1">  </span><span class="hl-6">http:</span><span class="hl-1"> { </span><span class="hl-0">transform</span><span class="hl-6">:</span><span class="hl-1"> ({ </span><span class="hl-6">before</span><span class="hl-1">, </span><span class="hl-6">after</span><span class="hl-1">, </span><span class="hl-6">onError</span><span class="hl-1"> }) </span><span class="hl-4">=&gt;</span><span class="hl-1"> ({ </span><span class="hl-6">before</span><span class="hl-1">, </span><span class="hl-6">after:</span><span class="hl-1"> </span><span class="hl-0">insertAfter</span><span class="hl-1">(</span><span class="hl-6">after</span><span class="hl-1">, </span><span class="hl-2">&#39;shape&#39;</span><span class="hl-1">, </span><span class="hl-6">mw</span><span class="hl-1"> </span><span class="hl-5">as</span><span class="hl-1"> </span><span class="hl-10">any</span><span class="hl-1">), </span><span class="hl-6">onError</span><span class="hl-1"> }) },</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

</li>
<li>Replace (advanced):
<ul>
<li>Provide phased arrays { before, after, onError } tagged to satisfy invariants
and zod enforcement if schemas are present. Avoid a single middleware
replacement unless no schemas are used, as Zod presence cannot be validated.</li>
</ul>
</li>
</ul>
<h2 id="typedoc" class="tsd-anchor-link">Typedoc<a href="#typedoc" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Public API is documented with TSDoc and published with <a href="https://typedoc.org/" target="_blank" class="external">TypeDoc</a>. Once generated:</p>
<ul>
<li>Docs hosting: <a href="https://docs.karmanivero.us/smoz">https://docs.karmanivero.us/smoz</a></li>
<li>Generate locally: <code>npm run docs</code></li>
</ul>
<h2 id="scripts" class="tsd-anchor-link">Scripts<a href="#scripts" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li><code>npm run build</code> — produce ESM/CJS and a DTS bundle</li>
<li><code>npm run test</code> — run the unit tests</li>
<li><code>npm run openapi</code> — build the OpenAPI document</li>
<li><code>npm run package</code> — Serverless package (no deploy)</li>
<li><code>npm run deploy</code> — Serverless deploy</li>
<li><code>npm run docs</code> — build typedoc (to ./docs)</li>
<li><code>npm run knip</code> — static usage analysis for dead code</li>
</ul>
<h2 id="faq" class="tsd-anchor-link">FAQ<a href="#faq" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><h3 id="why-handcrafted-openapi" class="tsd-anchor-link">Why “hand‑crafted” OpenAPI?<a href="#why-handcrafted-openapi" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>OpenAPI is a contract with consumers; we don’t want it to drift unpredictably from runtime schemas. SMOZ helps you compose and attach path items but does not auto‑derive from Zod. Use Zod for runtime validation; use OpenAPI to describe the surface you publish.</p>
<h3 id="zod-v5" class="tsd-anchor-link">Zod v5?<a href="#zod-v5" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>SMOZ targets Zod v4 today. Zod v5 introduces a smaller surface with some breaking changes; once it stabilizes across the ecosystem (zod‑openapi, middy examples), we’ll publish guidance for upgrading your app config and schemas.</p>
<h3 id="can-i-add-my-own-event-types" class="tsd-anchor-link">Can I add my own event types?<a href="#can-i-add-my-own-event-types" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Yes. Extend the base event type map schema in <code>App.create({ eventTypeMapSchema: baseEventTypeMapSchema.extend({ /* e.g., step */ }) })</code>. Use your custom token in <code>defineFunction({ eventType: 'step', ... })</code> — the wrapper will treat it as non‑HTTP unless you widen the HTTP event tokens at app construction time.</p>
<h2 id="license" class="tsd-anchor-link">License<a href="#license" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>BSD‑3‑Clause © Jason Williscroft</p>
<hr>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-chevronDown"></use></svg><h3>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-chevronDown"></use></svg><h3>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#smoz"><span>SMOZ</span></a><ul><li><a href="#highlights"><span>Highlights</span></a></li><li><a href="#install"><span>Install</span></a></li><li><a href="#quick-start"><span>Quick start</span></a></li><li><a href="#what-you-get-http-stack"><span>What you get (<wbr/>HTTP stack)</span></a></li><li><a href="#http-middleware-customization"><span>HTTP middleware customization</span></a></li><li><a href="#typedoc"><span>Typedoc</span></a></li><li><a href="#scripts"><span>Scripts</span></a></li><li><a href="#faq"><span>FAQ</span></a></li><li><ul><li><a href="#why-handcrafted-openapi"><span>Why “hand‑crafted” <wbr/>Open<wbr/>API?</span></a></li><li><a href="#zod-v5"><span>Zod v5?</span></a></li><li><a href="#can-i-add-my-own-event-types"><span>Can <wbr/>I add my own event types?</span></a></li></ul></li><li><a href="#license"><span>License</span></a></li></ul></div></details></div><div class="site-menu"><nav id="tsd-sidebar-links" class="tsd-navigation"><a href="https://github.com/karmaniverous/smoz" class="tsd-nav-link">GitHub</a></nav><nav class="tsd-navigation"><a href="modules.html">smoz</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
